{% extends "base.html" %}

{% block title %}Server Details{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-dark text-white border-secondary">
            <div class="card-header border-secondary">
                <h3 class="mb-0">üñ•Ô∏è Server Dossier</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h4 class="text-primary mb-3">{{ server.name }}</h4>
                        
                        {% if server.operator_name and server.operator_name != 'Unknown' %}
                        <div class="mb-2">
                            <span class="badge bg-secondary">Faction</span>
                            <a href="/?faction={{ server.operator_name|urlencode }}" class="text-info fw-bold text-decoration-none ms-1" title="View all servers by {{ server.operator_name }}">
                                {{ server.operator_name }}
                            </a>
                        </div>
                        {% endif %}
                        
                        <div class="mb-2">
                            <span class="badge bg-secondary">Connect</span>
                            <span class="font-monospace text-white select-all ms-1">
                                {{ server.display_addr }}
                            </span>
                        </div>

                        <div class="small border-start border-secondary ps-2 text-muted mt-3">
                            <div>
                                <strong>IP Address:</strong> {{ server.ip_address }}
                            </div>
                            <div>
                                <strong>Game Port:</strong> 
                                {% if server.game_port %}
                                    {{ server.game_port }}
                                {% else %}
                                    <span class="text-danger">MISSING</span>
                                {% endif %}
                            </div>
                            <div>
                                <strong>Query Port:</strong> {{ server.query_port }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted d-block">Last Seen</small>
                        <span class="local-time" data-time="{{ server.last_seen|datetime_str }}" style="visibility: hidden;">
                            {{ server.last_seen|datetime_str }}
                        </span>
                    </div>
                    <div class="col-md-3 text-end">
                        <a href="/" class="btn btn-outline-light btn-sm">‚Üê Back to Grid</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card p-4 border-0 bg-dark text-white mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="text-success mb-0">üü¢ Live Roster</h5>
        <span class="badge bg-success">{{ active_players|length }} Online</span>
    </div>
    
    <div class="table-responsive">
        <table class="table table-dark table-hover table-striped table-sm">
            <thead>
                <tr>
                    <th style="width: 40%;">Player Name</th>
                    <th>Score</th>
                    <th>Time Online</th>
                    <th>Joined At</th>
                </tr>
            </thead>
            <tbody>
                {% for p in active_players %}
                <tr>
                    <td>
                        <a href="/player/{{ p.player_id }}" class="text-decoration-none text-white fw-bold">
                            {{ p.name }}
                        </a>
                    </td>
                    <td class="text-warning font-monospace">{{ p.score }}</td>
                    <td>{{ p.duration|human_time }}</td>
                    <td class="text-muted small">
                        <span class="local-time" data-time="{{ p.first_seen|datetime_str }}" style="visibility: hidden;">
                            {{ p.first_seen|datetime_str }}
                        </span>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4" class="text-center text-muted py-3">
                        <em>The server is currently empty.</em>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-dark text-white border-secondary h-100">
            <div class="card-header border-secondary py-2">
                <h6 class="mb-0 text-muted">üó∫Ô∏è Map Rotation</h6>
            </div>
            <div class="card-body">
                <div style="height: 200px;">
                    <canvas id="mapChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card bg-dark text-white border-secondary h-100">
            <div class="card-header border-secondary py-2">
                <h6 class="mb-0 text-muted">‚åö Popular Join Times</h6>
            </div>
            <div class="card-body">
                <div style="height: 200px;">
                    <canvas id="trafficChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card p-4 border-0 bg-dark text-white">
    <h5 class="mb-3 text-muted">üìú Match Archives</h5>
    
    <div class="accordion accordion-flush" id="historyAccordion">
        {% for match in matches %}
        <div class="accordion-item bg-dark border-secondary">
            <h2 class="accordion-header" id="heading-{{ loop.index }}">
                <button class="accordion-button collapsed bg-dark text-white shadow-none" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ loop.index }}">
                    <div class="d-flex w-100 justify-content-between align-items-center me-3">
                        <div>
                            <span class="text-info fw-bold">{{ match.map_name }}</span>
                            <br>
                            <small class="text-muted local-time" data-time="{{ match.start_time|datetime_str if match.start_time else '' }}" style="visibility: hidden;">
                                {{ (match.start_time|datetime_str)[:16] if match.start_time else 'N/A' }}
                            </small>
                        </div>
                        
                        <div class="d-none d-md-block text-center">
                            <span class="badge bg-secondary">{{ match.match_duration|human_time }}</span>
                        </div>

                        <div class="text-end">
                            <span class="badge bg-primary">{{ match.player_count }} Players</span>
                            <div class="small text-muted mt-1">Total Score: {{ "{:,}".format(match.total_match_score) }}</div>
                        </div>
                    </div>
                </button>
            </h2>
            <div id="collapse-{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#historyAccordion">
                <div class="accordion-body p-0">
                    <table class="table table-dark table-striped table-sm mb-0">
                        <thead class="text-muted">
                            <tr>
                                <th class="ps-4">Operative</th>
                                <th class="text-end">Score</th>
                                <th class="text-end pe-4">Duration</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in match.roster %}
                            <tr>
                                <td class="ps-4">
                                    <a href="/player/{{ p.player_id }}" class="text-decoration-none text-white fw-bold">
                                        {{ p.name }}
                                    </a>
                                </td>
                                <td class="text-end text-warning font-monospace">{{ "{:,}".format(p.final_score) }}</td>
                                <td class="text-end pe-4">{{ p.total_time|human_time }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="text-center text-muted py-4">
            No match reports found. The archives are incomplete.
        </div>
        {% endfor %}
    </div>

    {% if pagination.pages > 1 %}
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                <a class="page-link bg-dark text-white border-secondary" href="{{ url_for('server_detail', server_id=server['id'], page=pagination.prev_num) }}">Previous</a>
            </li>
            <li class="page-item disabled">
                <span class="page-link bg-dark text-white border-secondary">Page {{ pagination.current }} of {{ pagination.pages }}</span>
            </li>
            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                <a class="page-link bg-dark text-white border-secondary" href="{{ url_for('server_detail', server_id=server['id'], page=pagination.next_num) }}">Next</a>
            </li>
        </ul>
    </nav>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    
    // --- Chart 1: Map Distribution (Doughnut) ---
    const ctxMap = document.getElementById('mapChart');
    if (ctxMap) {
        new Chart(ctxMap, {
            type: 'doughnut',
            data: {
                labels: {{ chart_map_labels | tojson }},
                datasets: [{
                    data: {{ chart_map_data | tojson }},
                    backgroundColor: [
                        '#dc3545', '#ffc107', '#28a745', '#17a2b8', '#6c757d'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { color: '#ccc', boxWidth: 12 } }
                }
            }
        });
    }

    // --- Chart 2: Traffic Heatmap (Bar) ---
    const ctxTraffic = document.getElementById('trafficChart');
    if (ctxTraffic) {
        new Chart(ctxTraffic, {
            type: 'bar',
            data: {
                labels: Array.from({length: 24}, (_, i) => i + ":00"), // 0:00 to 23:00
                datasets: [{
                    label: 'Player Joins (Last 30 Days)',
                    data: {{ chart_traffic_data | tojson }},
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { 
                        beginAtZero: true, 
                        grid: { color: '#444' },
                        ticks: { color: '#ccc' } 
                    },
                    x: { 
                        grid: { display: false },
                        ticks: { color: '#888', maxTicksLimit: 12 } 
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    // --- Timezone Fix ---
    const timeElements = document.querySelectorAll('.local-time');
    timeElements.forEach(el => {
        const utcTime = el.getAttribute('data-time');
        if (utcTime) {
            const date = new Date(utcTime + "Z");
            el.textContent = date.toLocaleString();
            el.style.visibility = 'visible';
        }
    });
});
</script>
{% endblock %}