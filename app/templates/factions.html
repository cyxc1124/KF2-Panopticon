{% extends "base.html" %}

{% block title %}Factions{% endblock %}

{% block head %}
<style>
    /* Custom Hover Effect for Live Faction Cards */
    .faction-card-hover {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .faction-card-hover:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 15px rgba(25, 135, 84, 0.4); /* Green Glow */
        border-color: #198754 !important;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="text-white border-bottom border-secondary pb-2">üè¥ Faction Intelligence</h2>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <h6 class="text-success text-uppercase mb-3"><i class="bi bi-broadcast me-2"></i>Live Activity (Top 6)</h6>
    </div>
    {% for f in live_top_5 %}
    <div class="col-md-2 mb-2">
        <a href="/?faction={{ f.operator_name|urlencode }}" class="text-decoration-none">
            <div class="card bg-dark border-success text-white text-center h-100 shadow-sm faction-card-hover">
                <div class="card-body p-2">
                    <div class="h6 text-success text-truncate mb-1" title="{{ f.operator_name }}">
                        {{ f.operator_name }}
                    </div>
                    <div class="display-6 fw-bold">{{ f.current_players }}</div>
                    <small class="text-muted">Troops Online</small>
                </div>
            </div>
        </a>
    </div>
    {% else %}
    <div class="col-12">
        <div class="alert alert-dark border-secondary">No factions currently active.</div>
    </div>
    {% endfor %}
</div>

<div class="card bg-dark text-white border-secondary mb-4">
    <div class="card-header border-secondary">
        <i class="bi bi-bar-chart-fill me-2"></i>30-Day Dominance (Top 10)
    </div>
    <div class="card-body">
        <div style="height: 300px;">
            <canvas id="factionChart"></canvas>
        </div>
    </div>
</div>

<div class="card bg-dark text-white border-secondary">
    <div class="card-header border-secondary">
        <ul class="nav nav-tabs card-header-tabs" id="factionTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active text-info" id="month-tab" data-bs-toggle="tab" data-bs-target="#month" type="button">
                    üìÖ Last 30 Days
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link text-warning" id="alltime-tab" data-bs-toggle="tab" data-bs-target="#alltime" type="button">
                    üìú All Time Records
                </button>
            </li>
        </ul>
    </div>
    
    <div class="card-body p-0">
        <div class="tab-content" id="factionTabsContent">
            
            <div class="tab-pane fade show active" id="month" role="tabpanel">
                <div class="table-responsive">
                    <table class="table table-dark table-striped table-hover mb-0" id="monthTable">
                        <thead class="text-secondary small text-uppercase">
                            <tr>
                                <th class="ps-4">Faction Identity</th>
                                <th class="text-center">Active Servers</th>
                                <th class="text-center">Unique Soldiers</th>
                                <th class="text-center">Total Playtime</th>
                                <th class="text-end pe-4">Last Contact</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in month_data %}
                            <tr>
                                <td class="ps-4">
                                    <a href="/?faction={{ row.operator_name|urlencode }}" class="text-info fw-bold text-decoration-none">
                                        {{ row.operator_name }}
                                    </a>
                                </td>
                                <td class="text-center text-muted">{{ row.server_count }}</td>
                                <td class="text-center text-white fw-bold">{{ "{:,}".format(row.unique_players) }}</td>
                                <td class="text-center text-secondary">{{ row.total_playtime_seconds|human_time }}</td>
                                <td class="text-end pe-4 small text-muted">
                                    <span class="local-time" data-time="{{ row.last_contact }}">
                                        {{ (row.last_contact|datetime_str)[:10] if row.last_contact else 'N/A' }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="alltime" role="tabpanel">
                <div class="table-responsive">
                    <table class="table table-dark table-striped table-hover mb-0" id="allTimeTable">
                        <thead class="text-secondary small text-uppercase">
                            <tr>
                                <th class="ps-4">Faction Identity</th>
                                <th class="text-center">Unique Soldiers (All Time)</th>
                                <th class="text-end pe-4">Total Playtime (Hours)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in all_time_data %}
                            <tr>
                                <td class="ps-4">
                                    <span class="text-warning fw-bold">{{ row.operator_name }}</span>
                                </td>
                                <td class="text-center">{{ "{:,}".format(row.unique_players) }}</td>
                                <td class="text-end pe-4 font-monospace">
                                    {{ "{:,.0f}".format(row.total_playtime_seconds / 3600) }} h
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    
    // --- Chart: 30-Day Faction Strength ---
    const ctx = document.getElementById('factionChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: {{ chart_data.labels | tojson }},
                datasets: [
                    {
                        label: 'Unique Soldiers (30d)',
                        data: {{ chart_data.players | tojson }},
                        backgroundColor: 'rgba(13, 202, 240, 0.6)', // Info Cyan
                        borderColor: '#0dcaf0',
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Total Hours Played (30d)',
                        data: {{ chart_data.hours | tojson }},
                        backgroundColor: 'rgba(255, 193, 7, 0.4)', // Warning Yellow
                        borderColor: '#ffc107',
                        borderWidth: 1,
                        type: 'line',
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: { grid: { color: '#444' }, ticks: { color: '#ccc' } },
                    y: { 
                        type: 'linear',
                        display: true,
                        position: 'left',
                        grid: { color: '#333' },
                        ticks: { color: '#0dcaf0' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: { drawOnChartArea: false },
                        ticks: { color: '#ffc107' }
                    }
                }
            }
        });
    }

    // --- Timezone Fix ---
    const timeElements = document.querySelectorAll('.local-time');
    timeElements.forEach(el => {
        const utcTime = el.getAttribute('data-time');
        if (utcTime) {
            const date = new Date(utcTime + "Z");
            el.textContent = date.toLocaleDateString(); // Only show Date for history
            el.style.visibility = 'visible';
        }
    });
});
</script>
{% endblock %}