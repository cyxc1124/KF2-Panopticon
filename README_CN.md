# KF2 Panopticon v1.0

[English](README.md) | 简体中文

**KF2 Panopticon** 是一个专为 *Killing Floor 2* 游戏服务器设计的数据聚合和分析平台。本应用程序通过 Steam Master Server API 和 A2S 协议查询各个游戏服务器，实时收集服务器状态、玩家活动和地图轮换等数据。它使用 SQLite 数据库的星型模式设计来存储历史数据，并提供基于 Web 的前端界面进行可视化和分析。

## 系统架构

本应用程序由两个主要组件构成：

1. **数据收集器 (`Query.py`)**: 一个多线程 Python 脚本，负责发现服务器、使用 A2S (Source Engine Query) 协议查询服务器状态，并对数据进行规范化处理。它处理服务器身份保存逻辑（动态 IP 处理），并清理服务器名称以将其分组为"派系"或运营商。
2. **Web 界面 (`webapp.py`)**: 基于 Flask 的 Web 应用程序，提供用户界面。它提供全局服务器网格、个人玩家历史记录、服务器详情和统计报告等视图。

## 主要功能

* **服务器监控**: 追踪公共 KF2 服务器的状态、玩家数量、地图轮换和地理位置。
* **玩家分析**: 记录会话历史、游戏时长和得分。
* **身份识别说明**: 玩家追踪基于 A2S 协议返回的玩家名称字符串。该协议不提供 SteamID；因此，如果玩家更改名称，将被视为新的独立实体。
* **队友检测**: 算法分析会话重叠，识别经常一起游戏的玩家。
* **派系智能**: 基于服务器名称的正则表达式模式匹配，将服务器分类为"派系"或"运营商"（例如，特定社区或托管服务商）。
* **数据清理**: 实现广泛的过滤功能，从服务器名称中剥离常见关键词（例如"Fast DL"、"Tickrate"），以识别核心服务器身份。

## 前置要求

* **Python 3.x**
* **Steam Web API Key**: 从 Valve 获取主服务器列表所需。

### 依赖项

安装所需的外部 Python 包：

```bash
pip install flask requests
```

*注意：该应用程序还使用了标准库，包括 `sqlite3`、`socket`、`struct`、`ipaddress`、`concurrent.futures`、`math`、`time`、`uuid`、`re` 和 `datetime`。*

## 配置

在运行应用程序之前，必须在源文件中配置文件路径和 API 密钥。

### 1. 数据收集器配置 (`Query.py`)

编辑 `Query.py` 并更新以下常量：

* **`STEAM_KEY`**: 设置为你有效的 Steam Web API Key。
* **`DB_FILE`**: 定义 SQLite 数据库文件存储的绝对路径（例如，`C:\\apps\\Webapp\\kf2_panopticon_v3_star.db`）。

### 2. Web 应用程序配置 (`webapp.py`)

编辑 `webapp.py` 并更新以下常量：

* **`DB_FILE`**: 确保此路径与 `Query.py` 中定义的 `DB_FILE` 路径匹配。
* **`app.secret_key`**: (可选) 更新 Flask 密钥以提高会话安全性。

## 使用方法

### 数据收集

要填充数据库，请执行查询脚本。此脚本充当 ETL（提取、转换、加载）过程。

```powershell
python Query.py
```

* 此过程会初始化数据库模式（如果不存在）。
* 它执行 Steam Master Server 列表扫描并更新服务器和玩家记录。
* **建议**: 使用 Windows 任务计划程序或 Cron 定期运行此脚本（例如，每 5 到 15 分钟一次），以维护历史数据。

### Web 界面

要启动仪表板，请执行 Web 应用程序脚本。

```powershell
python webapp.py
```

* **访问**: Web 服务器绑定到端口 `9001`。通过浏览器访问 `http://127.0.0.1:9001` 来使用界面。

## 技术说明

* **动态 IP 处理**: 系统包含逻辑，可检测已知服务器（通过名称和配置识别）是否更改了 IP 地址，从而允许将历史数据迁移到新地址。
* **回环处理**: 如果收集器在游戏服务器的同一台机器上运行，它会尝试将 `127.0.0.1` 地址解析为公共 IP，以确保数据库一致性。
* **缓存**: Web 应用程序使用具有 5 分钟生存时间 (TTL) 的内存 `DataCache`，以优化重型数据库查询（例如派系报告）的性能。

## 许可证

本软件按"原样"提供，不提供任何形式的保证。

